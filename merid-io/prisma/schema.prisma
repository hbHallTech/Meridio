// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  EMPLOYEE
  MANAGER
  HR
  ADMIN
}

enum LeaveStatus {
  DRAFT
  PENDING_MANAGER
  PENDING_HR
  APPROVED
  REFUSED
  CANCELLED
  RETURNED   // Renvoyé en brouillon pour clarification
}

enum HalfDay {
  MORNING
  AFTERNOON
  FULL_DAY
}

enum WorkflowStepType {
  MANAGER
  HR
}

enum WorkflowMode {
  SEQUENTIAL
  PARALLEL
}

enum ApprovalAction {
  APPROVED
  REFUSED
  RETURNED
}

enum DocumentType {
  FICHE_PAIE
  ATTESTATION_TRAVAIL
  CERTIFICAT_TRAVAIL
  CONTRAT
  AUTRE
}

enum DocumentStatus {
  NOUVEAU
  OUVERT
  ARCHIVE
  DELETED // Soft-delete, invisible pour l'employé
}

// ============================================================
// COMPANY & OFFICES
// ============================================================

model Company {
  id                String   @id @default(cuid())
  name              String
  logoUrl           String?
  websiteUrl        String?

  // ── Informations enrichies ──
  legalForm         String?  // SA, SARL, Sàrl, Association, etc.
  contactLastName   String?
  contactFirstName  String?
  address           String?
  addressComplement String?
  postalCode        String?
  city              String?
  country           String   @default("CH")
  email             String?
  phone             String?
  mobile            String?
  fax               String?
  facebook          String?
  twitter           String?
  skype             String?

  // ── SMTP Configuration ──
  smtpHost          String?
  smtpPort          Int?
  smtpSecure        Boolean  @default(false)
  smtpUser          String?
  smtpPassEncrypted String?  // AES-256-GCM encrypted
  smtpFrom          String?

  // ── Password Policy ──
  pwdExpirationEnabled  Boolean @default(true)
  pwdMaxAgeDays         Int     @default(90)
  pwdExpiryAlertDays    Int     @default(5)
  pwdMinLength          Int     @default(12)
  pwdRequireLowercase   Boolean @default(true)
  pwdRequireUppercase   Boolean @default(true)
  pwdRequireDigit       Boolean @default(true)
  pwdRequireSpecial     Boolean @default(true)
  pwdHistoryCount       Int     @default(5)
  pwdForceChangeOnFirst Boolean @default(true)
  pwdCheckDictionary    Boolean @default(false)

  // ── Advanced Settings ──
  enforce2FA            Boolean @default(false)
  inactivityTimeoutMin  Int     @default(30)
  auditRetentionDays    Int     @default(365)
  trialModeEnabled      Boolean @default(false)
  documentsModuleEnabled Boolean @default(false)
  documentsAiEnabled     Boolean @default(false)
  documentsNotifyEmail   String?  // Email pour réception de notifications documents
  documentsWebhookUrl    String?  // URL webhook ERP pour intégration
  documentsWebhookSecret String?  // Secret HMAC pour signature webhook
  documentsWebhookEnabled Boolean @default(false)
  emailLogoUrl          String?
  privacyPolicyUrl      String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  offices     Office[]
  notificationSettings CompanyNotificationSetting[]
  documentTemplates    DocumentTemplate[]
}

model CompanyNotificationSetting {
  id          String   @id @default(cuid())
  companyId   String
  type        String   // "NEW_REQUEST", "APPROVED", "REFUSED", "RETURNED", "REMINDER", "PASSWORD_EXPIRING", "NEW_LOGIN", "ACCOUNT_LOCKED", "PASSWORD_CHANGED", "CLOSURE"
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, type])
}

model UserNotificationPref {
  id        String   @id @default(cuid())
  userId    String
  type      String   // Same types as CompanyNotificationSetting
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, type])
}

model Office {
  id                    String   @id @default(cuid())
  name                  String   // ex: "Bureau de Genève", "Bureau de Tunis"
  country               String   // ex: "CH", "TN"
  city                  String   // ex: "Genève", "Tunis"
  defaultAnnualLeave    Int      @default(25) // Jours de congé annuel par défaut
  defaultOfferedDays    Int      @default(0)  // Congés offerts (ex-RTT)
  minNoticeDays         Int      @default(2)  // Délai minimum pour warning
  maxCarryOverDays      Int      @default(10) // Max jours reportables
  carryOverDeadline     String   @default("03-31") // Date limite report (MM-DD)
  probationMonths       Int      @default(3)  // Période d'essai en mois
  sickLeaveJustifFromDay Int     @default(2)  // Justificatif maladie à partir de X jours
  workingDays           String[] @default(["MON", "TUE", "WED", "THU", "FRI"])
  companyId             String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  company               Company  @relation(fields: [companyId], references: [id])
  users                 User[]
  teams                 Team[]
  publicHolidays        PublicHoliday[]
  companyClosures       CompanyClosure[]
  workflows             WorkflowConfig[]
  leaveTypeConfigs      LeaveTypeConfig[]
  exceptionalLeaveRules ExceptionalLeaveRule[]
}

// ============================================================
// USERS & TEAMS
// ============================================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique // doit être @halley-technologies.ch
  passwordHash      String
  firstName         String
  lastName          String
  roles             UserRole[]
  officeId          String
  teamId            String?
  hireDate          DateTime
  profilePictureUrl String?
  language          String    @default("fr") // "fr" ou "en"
  isActive          Boolean   @default(true)
  twoFactorCode     String?
  twoFactorExpiry   DateTime?
  passwordChangedAt DateTime?
  failedLoginAttempts Int     @default(0)
  lockedUntil       DateTime?
  resetPasswordToken String?
  resetPasswordExpiry DateTime?
  forcePasswordChange Boolean  @default(false)
  passwordExpiresAt   DateTime?
  lastPasswordChangeAt DateTime @default(now())
  passwordHistory     Json?    // Array of last 3 bcrypt hashes
  lastLoginDevice     Json?    // { ip, userAgent, lastSeen }
  theme             String    @default("system") // "light" | "dark" | "system"
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  office            Office    @relation(fields: [officeId], references: [id])
  team              Team?     @relation("TeamMembers", fields: [teamId], references: [id])
  managedTeam       Team?     @relation("TeamManager")
  leaveRequests     LeaveRequest[]
  leaveBalances     LeaveBalance[]
  approvals         ApprovalStep[]
  delegationsFrom   Delegation[] @relation("DelegationFrom")
  delegationsTo     Delegation[] @relation("DelegationTo")
  auditLogs         AuditLog[]
  notifications     Notification[]
  notificationPrefs UserNotificationPref[]
  documents         Document[]     @relation("UserDocuments")
  createdDocuments  Document[]     @relation("DocumentCreatedBy")
  modifiedDocuments Document[]     @relation("DocumentModifiedBy")
}

model Team {
  id         String   @id @default(cuid())
  name       String
  managerId  String   @unique
  officeId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  manager    User     @relation("TeamManager", fields: [managerId], references: [id])
  office     Office   @relation(fields: [officeId], references: [id])
  members    User[]   @relation("TeamMembers")
  workflows  WorkflowConfig[] @relation("WorkflowTeams")
}

model Delegation {
  id          String    @id @default(cuid())
  fromUserId  String    // Manager qui délègue
  toUserId    String    // Utilisateur qui reçoit la délégation
  startDate   DateTime
  endDate     DateTime
  createdBy   String    // "MANAGER" ou "ADMIN"
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())

  fromUser    User      @relation("DelegationFrom", fields: [fromUserId], references: [id])
  toUser      User      @relation("DelegationTo", fields: [toUserId], references: [id])
}

// ============================================================
// LEAVE TYPES & CONFIGURATION
// ============================================================

model LeaveTypeConfig {
  id                  String   @id @default(cuid())
  officeId            String
  code                String   // ex: "ANNUAL", "OFFERED", "SICK", "UNPAID", "MATERNITY", "PATERNITY", "EXCEPTIONAL", "TELEWORK"
  label_fr            String   // ex: "Congé annuel"
  label_en            String   // ex: "Annual leave"
  requiresAttachment  Boolean  @default(false)
  attachmentFromDay   Int?     // Justificatif à partir de X jours (pour maladie)
  deductsFromBalance  Boolean  @default(true)
  balanceType         String?  // "ANNUAL", "OFFERED", null (pour types sans solde)
  isActive            Boolean  @default(true)
  color               String   @default("#3B82F6") // Couleur pour le calendrier
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  office              Office   @relation(fields: [officeId], references: [id])
  leaveRequests       LeaveRequest[]

  @@unique([officeId, code])
}

model ExceptionalLeaveRule {
  id         String   @id @default(cuid())
  officeId   String
  reason_fr  String   // ex: "Mariage"
  reason_en  String   // ex: "Wedding"
  maxDays    Int      // ex: 3
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  office     Office   @relation(fields: [officeId], references: [id])
}

// ============================================================
// WORKFLOW CONFIGURATION
// ============================================================

model WorkflowConfig {
  id         String       @id @default(cuid())
  officeId   String?
  mode       WorkflowMode @default(SEQUENTIAL)
  isActive   Boolean      @default(true)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  office     Office?      @relation(fields: [officeId], references: [id])
  steps      WorkflowStep[]
  teams      Team[]       @relation("WorkflowTeams")
}

model WorkflowStep {
  id               String           @id @default(cuid())
  workflowConfigId String
  stepOrder        Int              // 1, 2, ...
  stepType         WorkflowStepType // MANAGER ou HR
  isRequired       Boolean          @default(true)
  createdAt        DateTime         @default(now())

  workflowConfig   WorkflowConfig   @relation(fields: [workflowConfigId], references: [id])

  @@unique([workflowConfigId, stepOrder])
}

// ============================================================
// LEAVE REQUESTS & APPROVALS
// ============================================================

model LeaveRequest {
  id                  String      @id @default(cuid())
  userId              String
  leaveTypeConfigId   String
  startDate           DateTime
  endDate             DateTime
  startHalfDay        HalfDay     @default(FULL_DAY)
  endHalfDay          HalfDay     @default(FULL_DAY)
  totalDays           Float       // Calculé: nombre de jours ouvrés
  status              LeaveStatus @default(DRAFT)
  reason              String?     // Motif (optionnel pour l'employé)
  exceptionalReason   String?     // Raison du congé exceptionnel
  attachmentUrls      String[]    // Chemins vers les justificatifs
  isCompanyClosure    Boolean     @default(false) // Si c'est un congé imposé
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  user                User        @relation(fields: [userId], references: [id])
  leaveTypeConfig     LeaveTypeConfig @relation(fields: [leaveTypeConfigId], references: [id])
  approvalSteps       ApprovalStep[]
}

model ApprovalStep {
  id              String         @id @default(cuid())
  leaveRequestId  String
  approverId      String
  stepType        WorkflowStepType
  stepOrder       Int
  action          ApprovalAction?
  comment         String?        // Motif obligatoire si REFUSED ou RETURNED
  decidedAt       DateTime?
  createdAt       DateTime       @default(now())

  leaveRequest    LeaveRequest   @relation(fields: [leaveRequestId], references: [id])
  approver        User           @relation(fields: [approverId], references: [id])
}

// ============================================================
// LEAVE BALANCES
// ============================================================

model LeaveBalance {
  id              String   @id @default(cuid())
  userId          String
  year            Int      // ex: 2026
  balanceType     String   // "ANNUAL", "OFFERED"
  totalDays       Float    // Total alloué (prorata inclus)
  usedDays        Float    @default(0)
  pendingDays     Float    @default(0) // Jours en attente de validation
  carriedOverDays Float    @default(0) // Jours reportés de l'année précédente
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id])

  @@unique([userId, year, balanceType])
}

// ============================================================
// CALENDAR: HOLIDAYS & CLOSURES
// ============================================================

model PublicHoliday {
  id        String   @id @default(cuid())
  officeId  String
  date      DateTime
  name_fr   String
  name_en   String?
  type      String   @default("PUBLIC") // "PUBLIC", "RELIGIOUS", "NATIONAL"
  createdAt DateTime @default(now())

  office    Office   @relation(fields: [officeId], references: [id])

  @@unique([officeId, date])
}

model CompanyClosure {
  id        String   @id @default(cuid())
  officeId  String
  startDate DateTime
  endDate   DateTime
  reason_fr String
  reason_en String?
  year      Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  office    Office   @relation(fields: [officeId], references: [id])
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "NEW_REQUEST", "APPROVED", "REFUSED", "RETURNED", "REMINDER", "CLOSURE", "PASSWORD_CHANGED"
  title_fr  String
  title_en  String
  body_fr   String
  body_en   String
  data      Json?    // Données supplémentaires (ex: leaveRequestId)
  isRead    Boolean  @default(false)
  sentByEmail Boolean @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

// ============================================================
// DOCUMENTS RH
// ============================================================

model Document {
  id              String         @id @default(cuid())
  userId          String
  name            String         // ex: "Fiche_Paie_02-2026.pdf"
  type            DocumentType
  status          DocumentStatus @default(NOUVEAU)
  filePath        String         // Vercel Blob URL (private)
  fileSize        Int            @default(0)   // bytes
  mimeType        String         @default("application/pdf")
  metadata        Json?          // ex: { "mois": "02", "annee": "2026" }
  createdById     String?        // user_id RH/admin ou null pour SYSTEM
  modifiedById    String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  user            User           @relation("UserDocuments", fields: [userId], references: [id])
  createdBy       User?          @relation("DocumentCreatedBy", fields: [createdById], references: [id])
  modifiedBy      User?          @relation("DocumentModifiedBy", fields: [modifiedById], references: [id])

  @@index([userId, status])
  @@index([userId, type])
  @@index([createdAt])
}

// ============================================================
// DOCUMENT TEMPLATES
// ============================================================

model DocumentTemplate {
  id          String       @id @default(cuid())
  companyId   String
  name        String       // ex: "Fiche de paie standard"
  type        DocumentType // Lié au type de document
  subject     String?      // Sujet (pour emails associés)
  content     String       // Contenu HTML/Markdown du template
  variables   String[]     // Variables disponibles: ["employee_name", "month", "year", ...]
  isActive    Boolean      @default(true)
  isDefault   Boolean      @default(false) // Template par défaut pour ce type
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  company     Company      @relation(fields: [companyId], references: [id])

  @@unique([companyId, name])
  @@index([companyId, type])
}

// ============================================================
// AUDIT LOG (immutable — no updates or deletes)
// ============================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String   // ex: "LOGIN_SUCCESS", "CREATE_LEAVE", "RBAC_DENIED"
  success    Boolean  @default(true)
  entityType String?  // ex: "User", "LeaveRequest", "Office"
  entityId   String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
  @@index([action])
}
